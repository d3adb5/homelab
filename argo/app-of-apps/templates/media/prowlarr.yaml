apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prowlarr
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: media

  sources:
    - repoURL: {{ .Values.repository.url }}
      targetRevision: {{ .Values.repository.targetRevision }}
      path: argo/media/prowlarr

    - repoURL: https://oauth2-proxy.github.io/manifests
      targetRevision: 8.3.1
      chart: oauth2-proxy

      helm:
        valuesObject:
          config:
            existingSecret: prowlarr-oidc-secrets

            configFile: |-
              email_domains = ["*"]
              provider = "keycloak-oidc"
              oidc_issuer_url = "https://id.d3adb5.ca/realms/core"
              redirect_url = "https://prowlarr.d3adb5.ca/oauth2/callback"
              code_challenge_method = "S256"
              allowed_groups = ["/Prowlarr"]

          ingress:
            enabled: true
            className: nginx
            annotations:
              {{- toYaml .Values.ingress.oauth2ProxyIngressAnnotations | nindent 14 }}
            hosts:
              - "prowlarr.d3adb5.ca"
            path: /oauth2
            tls:
              - hosts:
                  - "prowlarr.d3adb5.ca"
                secretName: prowlarr-tls

    - repoURL: https://charts.d3adb5.net
      targetRevision: 1.1.0
      chart: stateful

      helm:
        valuesObject:
          replicaCount: 1
          image:
            repository: lscr.io/linuxserver/prowlarr
            tag: "2.0.5@sha256:4f2a6d597845b2f3e19284b1d982b3e0b4bd7c22472c2979c956aa198b83f472"
            pullPolicy: IfNotPresent
          service:
            port: 9696
          ingress:
            enabled: true
            host: prowlarr.d3adb5.ca
            className: nginx
            tls:
              enabled: true
              secretName: prowlarr-tls
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt
              {{- toYaml .Values.ingress.oauth2ProxyAnnotations | nindent 14 }}
          extraEnv:
            - name: TZ
              value: America/Vancouver
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
          extraVolumeMounts:
            - name: config
              mountPath: /config
          extraVolumeClaimTemplates:
            - metadata:
                name: config
              spec:
                accessModes: [ "ReadWriteOnce" ]
                storageClassName: longhorn
                resources:
                  requests:
                    storage: 2Gi

  destination:
    server: https://kubernetes.default.svc
    namespace: {{ .Values.media.namespace }}

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
